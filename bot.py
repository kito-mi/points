from telegram import Update
from telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
import os
from main_sqlalch import UserDB

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
DATABASE_URL = "sqlite:///./points.db"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /start"""
    user = update.effective_user
    db = SessionLocal()
    
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        db_user = db.query(UserDB).filter(UserDB.telegram_id == user.id).first()
        
        if not db_user:
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
            db_user = UserDB(
                telegram_id=user.id,
                username=user.username,
                first_name=user.first_name,
                last_name=user.last_name,
                points=0
            )
            db.add(db_user)
            db.commit()
            
            # Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            await update.message.reply_text(
                f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}! ğŸ‘‹\n"
                f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰\n"
                f"Ù…Ø¹Ø±Ù Ø­Ø³Ø§Ø¨Ùƒ: {user.id}\n"
                f"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @{user.username if user.username else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}"
            )
        else:
            # Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            await update.message.reply_text(
                f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}! ğŸ‘‹\n"
                f"Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„! âœ¨"
            )
    except Exception as e:
        await update.message.reply_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
        print(f"Error in start command: {str(e)}")
    finally:
        db.close()

def main():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
    bot_token = os.getenv("BOT_TOKEN")
    if not bot_token:
        raise ValueError("ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© BOT_TOKEN")
    
    # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
    app = ApplicationBuilder().token(bot_token).build()
    app.add_handler(CommandHandler("start", start))
    app.run_polling()

if __name__ == "__main__":
    main()
